// ==UserScript==
// @name         Twitter PageManager
// @namespace    http://tampermonkey.net/
// @version      5.0
// @description  try to take over the world!
// @author       You
// @match        https://x.com/*
// @grant        none
// @license      GNU GPLv3
// @icon         https://www.google.com/s2/favicons?domain=x.com
// @run-at       document-body
// @noframes
// ==/UserScript==

(function() {
  'use strict';

  // ==========================================================
  // 変数宣言
  const twMain = 'main[role="main"]';
  const twColumns = 'div[data-testid="cellInnerDiv"]';
  const remColumn = ':not(.removeItem)';
  const abc = JSON.parse(window.sessionStorage.getItem('ABC')) || null;
  // 可変数
  let timeCount;
  // ==========================================================

  // eslint-disable-next-line no-unused-vars
  const isNuN = (selector) => {
    if (selector === null || selector === undefined || selector === '') { return true; } else { return false; }
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelector = async (selector, node = document) => {
    let obj = null;
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 100));
      obj = node.querySelector(selector);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorCount = async (cnt, selector, node = document) => {
    let obj = null;
    let num = 0;
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 1000));
      if (num < cnt) {
        obj = node.querySelector(selector);
        num++;
        if (!obj) { return obj; }
      } else {
        break;
      }
    }
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 10000));
      obj = node.querySelector(selector);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorIframe = async (selector1, selector2, node = document) => {
    let obj = null;
    while (!obj) {
      // iframe.contentWindow.document === iframe.contentDocument
      await new Promise(resolve => setTimeout(resolve, 500));
      obj = node.querySelector(selector1).contentDocument.querySelector(selector2);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const deleteParam = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;
    params.delete(param);

    return url;
  };
  // eslint-disable-next-line no-unused-vars
  const searchParams = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    console.log('url section', url);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;

    return params.get(param);
  };
  // eslint-disable-next-line no-unused-vars
  const getParam = (name, url) => {
    if (!url) url = window.location.href;
    name = name.replace(/[\\[\]]/g, '\\$&');
    let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    let results = regex.exec(url);

    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };
  // eslint-disable-next-line no-unused-vars
  const userAgent = () => {
    const userDevice = navigator.userAgent;
    if (userDevice.indexOf('iPhone') > 0 || userDevice.indexOf('iPod') > 0 || userDevice.indexOf('Android') > 0 && userDevice.indexOf('Mobile') > 0) {
      return false;
    } else if (userDevice.indexOf('iPad') > 0 || userDevice.indexOf('Android') > 0) {
      return false;
    } else {
      // pc
      return true;
    }
  };

  const polling = (cnt) => {
    timeCount = setTimeout(async () => {
      let len = removeElements(cnt);
      polling(len);
    }, 500);
  };
  const removeElements = (cnt) => {
    let tweets = document.querySelectorAll(twColumns + remColumn);
    if (tweets.length <= cnt) { return cnt; }
    // console.log(tweets.length);

    for (const tweet of tweets) {
      const words = isNuN(abc) ? '' : abc.hideword;
      if (isNuN(words)) { return false; }
      // 非表示対象文字列
      for (const word of words) {
        const regWord = new RegExp(word, 'gis');
        if (regWord.test(tweet.textContent)) {
          console.log([word, tweet.textContent]);
          tweet.style.setProperty('display', 'none', 'important');
          tweet.classList.add('removeItem');
        }
      }
    }
    tweets = document.querySelectorAll(twColumns + remColumn);
    return tweets.length;
  };
  const initial = async () => {
    await waitQuerySelector(twColumns);

    // console.log('refresh tweets list');
    await polling(0);
  };
  const twPath = async () => {
    let path, label;
    // Mutation Observer
    const targetNode = await waitQuerySelector(twMain);
    // const config = { 'attributes': true, 'childList': false, 'subtree': false };
    const config = { 'attributes': false, 'childList': true, 'subtree': true };
    const observer = new MutationObserver(async () => {
      const tab = await waitQuerySelector('nav[aria-live="polite"][role="navigation"] div[role="presentation"] *[role="tab"][aria-selected="true"]');
      const tabLabel = tab.textContent;
      if (path !== location.pathname || label !== tabLabel) {
        path = location.pathname;
        label = tabLabel;

        observer.disconnect();
        clearTimeout(timeCount);

        // 10秒待機
        // await new Promise(resolve => setTimeout(resolve, 10000));
        await initial();
        observer.observe(targetNode, config);
      }
    });
    observer.observe(targetNode, config);
  };

  twPath();
})();
