// ==UserScript==
// @name         Youtube PageManager
// @namespace    http://tampermonkey.net/
// @version      4.2
// @description  try to take over the world!
// @author       You
// @match        https://*.youtube.com/*
// @exclude      https://music.youtube.com/*
// @exclude      https://studio.youtube.com/*
// @grant        none
// @icon         https://www.google.com/s2/favicons?domain=youtube.com
// @run-at       document-body
// @noframes
// ==/UserScript==

(function() {
  'use strict';

  // ==========================================================
  // 変数宣言
  const isChatMode = false;
  const scale = 'scale(0.8)';
  const waitTime = 500;
  const manager = 'ytd-app, ytm-app[id="app"i]';
  const itemsArray = [
    { device: 'www.youtube.com', path: '^/$', area: '[page-subtype="home"i] div#primary > ytd-rich-grid-renderer > div#contents', stylus: 'transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'www.youtube.com', path: '^/feed/subscriptions', area: '[page-subtype="subscriptions"i] div#primary > ytd-rich-grid-renderer > div#contents', stylus: 'transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'www.youtube.com', path: '^/watch|^/live', area: 'ytd-watch-flexy div#related div#items', stylus: 'transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'www.youtube.com', path: '^/@.+/(videos|streams)|^/channel/.+/(videos|streams)|^/c/.+/(videos|streams)|^/user/.+/(videos|streams)|^/u/.+/(videos|streams)', area: '[page-subtype="channels"i] div#primary > ytd-rich-grid-renderer > div#contents', stylus: 'transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'www.youtube.com', path: '^/results', area: 'ytd-two-column-search-results-renderer > div#primary > ytd-section-list-renderer > div#contents', stylus: 'transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'm.youtube.com', path: '^/$', area: 'div.tab-content[tab-identifier="FEwhat_to_watch"i] div.rich-grid-renderer-contents', stylus: 'display: block; transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'm.youtube.com', path: '^/feed/subscriptions', area: 'div.tab-content[tab-identifier="FEsubscriptions"i] lazy-list', stylus: 'display: block; transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'm.youtube.com', path: '^/watch|^/live', area: '[section-identifier="related-items"] > lazy-list, div.related-items-container lazy-list', stylus: 'display: block; transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'm.youtube.com', path: '^/@.+/(videos|streams)|^/channel/.+/(videos|streams)|^/c/.+/(videos|streams)|^/user/.+/(videos|streams)|^/u/.+/(videos|streams)', area: 'ytm-tab-renderer div.rich-grid-renderer-contents', stylus: 'display: block; transform: ' + scale + ' !important; pointer-events: none !important;' },
    { device: 'm.youtube.com', path: '^/results', area: 'ytm-search > ytm-section-list-renderer > lazy-list', stylus: 'display: block; transform: ' + scale + ' !important; pointer-events: none !important;' },
  ];
  const regWatch = '^/watch|^/live';
  const regSearch = '^/results';
  const regChannel = '^/@.+|^/channel/.+|^/c/.+|^/user/.+|^/u/.+';
  const excChannel = '@tsunomiyaP|UCSsBxdA7yg523PegCT7O7Mg';
  const abc = JSON.parse(window.sessionStorage.getItem('ABC')) || null;
  // 可変数
  let userName = window.sessionStorage.getItem('channel') || '';
  // ==========================================================
  // 静的style適用エリア
  const elemStyle = document.createElement('style');
  elemStyle.id = 'ytStylusManager';
  document.head.insertAdjacentElement('beforeend', elemStyle);

  // 可変style適用エリア
  const elemDom = document.createElement('style');
  elemDom.id = 'ytStylusManagerDom';
  document.head.insertAdjacentElement('beforeend', elemDom);

  // 可変style適用エリア
  const elemMov = document.createElement('style');
  elemMov.id = 'ytStylusManagerMovie';
  document.head.insertAdjacentElement('beforeend', elemMov);

  elemStyle.textContent += ' .remove_item { display: none !important; } ';
  // [ショート]動画 削除
  elemStyle.textContent += 'ytd-rich-shelf-renderer:has([href*="/shorts/"i]), grid-shelf-view-model { display: none !important; } ';
  // [ショート]タブ 削除
  elemStyle.textContent += 'ytd-guide-section-renderer > div#items.ytd-guide-section-renderer > ytd-guide-entry-renderer > a#endpoint[title="ショート"i], ytd-mini-guide-renderer > div#items.ytd-mini-guide-renderer > ytd-mini-guide-entry-renderer > a#endpoint[title="ショート"i], ytm-pivot-bar-renderer[role="tablist"i] > ytm-pivot-bar-item-renderer:has(div.pivot-shorts[role="tab"i]) { display: none !important; } ';
  // バナー削除
  elemStyle.textContent += 'ytd-rich-section-renderer:has([class*="banner-renderer"i]) { display: none !important; } ';
  // サイドバー 削除
  elemStyle.textContent += 'ytd-guide-renderer > div#sections > *:nth-child(n+2) { display: none !important; } ';
  elemStyle.textContent += 'ytd-guide-renderer > div#footer { display: none !important; } ';
  // 任意チャンネルエリア 削除
  elemStyle.textContent += 'div[role="tablist"i] > yt-tab-shape[tab-title="ホーム"i], div[role="tablist"i] > yt-tab-shape[tab-title="ショート"i], div.yt-tab-group-shape-wiz__slider, div.tabGroupShapeSlider { display: none !important; } ';

  // 動画
  elemStyle.textContent += 'ytd-watch-flexy > div#full-bleed-container:not(:has(div#player-container)) { display: none !important; } ';
  // 動画再生後の動画一覧非表示
  elemStyle.textContent += 'div[class="html5-endscreen ytp-player-content videowall-endscreen"i], div[class*="ytp-ce-element"i], div[class="ytp-endscreen-content"i] { display: none !important; } ';
  elemStyle.textContent += 'div.ytp-fullscreen-grid { display: none !important; } ';
  // 動画表示切り替えボタン削除
  elemStyle.textContent += 'button.ytp-size-button { display: none !important; } ';
  // チャンネル動画、チャンネル削除 (pc)
  elemStyle.textContent += 'ytd-shelf-renderer:has(ytd-vertical-list-renderer), ytd-search ytd-channel-renderer { display: none !important; } ';
  // プレビュー動画、チャンネル削除 (mobile)
  elemStyle.textContent += 'ytm-video-preview, ytm-search ytm-compact-channel-renderer { display: none !important; } ';
  // コメント
  elemStyle.textContent += 'ytm-watch div.ytVideoMetadataCarouselViewModelCarouselContainer:has(yt-carousel-item-view-model[aria-label="コメント"i]) { display: none !important; } ';

  // ホーム
  elemStyle.textContent += '[page-subtype="home"i] div[id="contents"i] > ytd-rich-section-renderer:has(ytd-rich-shelf-renderer) { display: none; } ';
  elemStyle.textContent += 'div[tab-title="ホーム"i] ytm-rich-grid-renderer > div > ytm-rich-section-renderer { display: none; } ';
  // 広告系
  elemStyle.textContent += '[page-subtype="home"i] div[id="primary"i] > ytd-rich-grid-renderer ytd-statement-banner-renderer { display: none; } ';
  elemStyle.textContent += '[page-subtype="home"i] div[id="primary"i] div[id="masthead-ad"i]:has(ytd-ad-slot-renderer) { display: none; } ';
  elemStyle.textContent += '[page-subtype="home"i] div[id="contents"i] > ytd-rich-item-renderer:has(ytd-ad-slot-renderer) { display: none; } ';
  elemStyle.textContent += 'div[tab-title="ホーム"i] ytm-rich-grid-renderer > div > ytm-statement-banner-renderer { display: none; } ';
  elemStyle.textContent += 'div[tab-title="ホーム"i] ytm-rich-grid-renderer > div > ytm-rich-item-renderer.is-in-first-col:has(ad-slot-renderer) { display: none; } ';

  // アプリで開く(サインイン)
  elemStyle.textContent += 'header.mobile-topbar-header div.mobile-topbar-header-sign-in-button { display: none !important; } ';

  if (!isChatMode) { elemStyle.textContent += 'div#chat-container { display: none !important; } '; }

  // 初期表示
  for (const yt of itemsArray) {
    // 非表示
    elemStyle.textContent += yt.area + ' .target:not(.show) { display: none !important; visibility: hidden !important; } ';
    // 拡大縮小
    elemStyle.textContent += yt.area + ' .target.minScale:not(:has(div[class*="subheader"i])) > * { ' + yt.stylus + ' } ';
    // [ショート]動画 削除
    elemStyle.textContent += yt.area + ' .target:has(a[href*="/shorts"i]) { display: none; } ';
    // [Mix & playlist] [他(headline)]動画 削除
    elemStyle.textContent += yt.area + ' .target:has(a[href*="&list="i], #rich-shelf-header-container, .rich-shelf-header, chips-shelf-with-video-shelf-renderer, ytd-brand-video-singleton-renderer) { display: none; } ';
  }

  // Modal画面
  const modal = document.createElement('div');
  modal.id = 'ytLoader';
  const loader = document.createElement('div');
  modal.appendChild(loader);
  document.body.insertAdjacentElement('beforeend', modal);
  // ==========================================================

  // eslint-disable-next-line no-unused-vars
  const isNuN = (selector) => {
    if (selector === null || selector === undefined || selector === '') { return true; } else { return false; }
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelector = async (selector, node = document) => {
    let obj = null;
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 100));
      obj = node.querySelector(selector);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorCount = async (cnt, selector, node = document) => {
    await new Promise(resolve => setTimeout(resolve, 1000 * cnt));
    return node.querySelector(selector);
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorIframe = async (selector1, selector2, node = document) => {
    let obj = null;
    while (!obj) {
      // iframe.contentWindow.document === iframe.contentDocument
      await new Promise(resolve => setTimeout(resolve, 500));
      obj = node.querySelector(selector1).contentDocument.querySelector(selector2);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const deleteParam = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;
    params.delete(param);

    return url;
  };
  // eslint-disable-next-line no-unused-vars
  const searchParams = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    console.log('url section', url);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;

    return params.get(param);
  };
  // eslint-disable-next-line no-unused-vars
  const getParam = (name, url) => {
    if (!url) url = window.location.href;
    name = name.replace(/[\\[\]]/g, '\\$&');
    let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    let results = regex.exec(url);

    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };
  // eslint-disable-next-line no-unused-vars
  const userAgent = () => {
    const userDevice = navigator.userAgent;
    if (userDevice.indexOf('iPhone') > 0 || userDevice.indexOf('iPod') > 0 || userDevice.indexOf('Android') > 0 && userDevice.indexOf('Mobile') > 0) {
      return false;
    } else if (userDevice.indexOf('iPad') > 0 || userDevice.indexOf('Android') > 0) {
      return false;
    } else {
      // pc
      return true;
    }
  };

  const channelManager = async (name) => {
    // youtube Area Manager
    // console.log(pathChannelEtc.length);
    window.sessionStorage.setItem('channel', name);
    const pathChannelEtc = location.pathname.split(/@|\/channel\/|\/c\/|\/user\/|\/u\//)[1].split('/');

    if (1 === pathChannelEtc.length) {
      if (!isNuN(document.querySelector('div[role="tablist"i] > yt-tab-shape[tab-title="ホーム"i]'))) { document.querySelector('div[role="tablist"i] > yt-tab-shape[tab-title="ホーム"i]').ariaSelected = false; }

      await waitQuerySelector('div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="ライブ"i], div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="動画"i]');
      if (!isNuN(document.querySelector('div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="ライブ"i]'))) {
        // document.querySelector('div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="ライブ"i]').click();
        location.replace(location.pathname + '/streams');
      } else if (!isNuN(document.querySelector('div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="動画"i]'))) {
        // document.querySelector('div[role="tablist"i] > yt-tab-shape[role="tab"i][tab-title="動画"i]').click();
        location.replace(location.pathname + '/videos');
      } else {
        location.replace(location.pathname.replace(/\/streams|\/videos/, '/'));
      }
    }
  };
  const ytChatArea = async () => {
    if ('www.youtube.com' !== location.hostname) { return false; }
    const watcher = new RegExp(regWatch, 'gis');
    if (!watcher.test(location.pathname)) { return false; }
    console.log('> chat area create...');
    const chat = await waitQuerySelectorCount(5, 'div#chat-container');
    if (!isNuN(chat)) { chat.remove(); }
  };
  const removeMovieInformation = async (item) => {
    const mode = {'pc': {}, 'mobile': {}};

    const watcher = new RegExp(regWatch, 'gis');
    const device = 'www.youtube.com' !== location.hostname ? mode.mobile : mode.pc;
    const youtubeItem = {};

    if (watcher.test(location.pathname)) {
      await waitQuerySelector('div#owner ytd-video-owner-renderer ytd-channel-name#channel-name #text-container > yt-formatted-string#text[title], ytm-slim-owner-renderer h3.slim-owner-channel-name span');
      // pc 動画
      mode.pc.ytTitle = isNuN(item.querySelector('yt-lockup-view-model div.yt-lockup-metadata-view-model__text-container span')) ? '' : item.querySelector('yt-lockup-view-model div.yt-lockup-metadata-view-model__text-container span').textContent;
      mode.pc.userNam = isNuN(item.querySelector('yt-lockup-view-model div.yt-content-metadata-view-model__metadata-row span')) ? '' : item.querySelector('yt-lockup-view-model div.yt-content-metadata-view-model__metadata-row span').textContent;
      // mobile
      mode.mobile.ytTitle = isNuN(item.querySelector('div.details h3.media-item-headline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span')) ? '' : item.querySelector('div.details h3.media-item-headline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span').textContent;
      mode.mobile.userNam = isNuN(item.querySelector('div.details ytm-badge-and-byline-renderer span.YtmBadgeAndBylineRendererItemByline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span')) ? '' : item.querySelector('div.details ytm-badge-and-byline-renderer span.YtmBadgeAndBylineRendererItemByline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span').textContent;

      const strData = device;
      youtubeItem.ytTitle = strData.ytTitle;
      youtubeItem.userNam = strData.userNam;

      let user = '';
      if ('www.youtube.com' === location.hostname) {
        const channel = document.querySelector('div#owner ytd-video-owner-renderer ytd-channel-name#channel-name #text-container > yt-formatted-string#text[title]');
        user = channel.title;
      }
      if ('m.youtube.com' === location.hostname) {
        const channel = document.querySelector('ytm-slim-owner-renderer h3.slim-owner-channel-name span');
        user = channel.textContent;
      }

      console.log(user, youtubeItem.userNam);
      if (user !== youtubeItem.userNam) { item.classList.add('remove_item'); }
    } else {
      // pc 動画
      mode.pc.ytTitle = isNuN(item.querySelector('yt-lockup-view-model div.yt-lockup-metadata-view-model__text-container span')) ? '' : item.querySelector('yt-lockup-view-model div.yt-lockup-metadata-view-model__text-container span').textContent;
      mode.pc.userNam = isNuN(item.querySelector('yt-lockup-view-model div.yt-content-metadata-view-model__metadata-row span')) ? '' : item.querySelector('yt-lockup-view-model div.yt-content-metadata-view-model__metadata-row span').textContent;
      // mobile
      mode.mobile.ytTitle = isNuN(item.querySelector('div.details h3.media-item-headline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span')) ? '' : item.querySelector('div.details h3.media-item-headline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span').textContent;
      mode.mobile.userNam = isNuN(item.querySelector('div.details ytm-badge-and-byline-renderer span.YtmBadgeAndBylineRendererItemByline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span')) ? '' : item.querySelector('div.details ytm-badge-and-byline-renderer span.YtmBadgeAndBylineRendererItemByline > span, div.YtmCompactMediaItemMetadata h4.YtmCompactMediaItemHeadline > span').textContent;

      const strData = device;
      youtubeItem.ytTitle = strData.ytTitle;
      youtubeItem.userNam = strData.userNam;
    }

    if (isNuN(youtubeItem.ytTitle)) { return false; }
    if (isNuN(youtubeItem.userNam)) { return false; }

    const words = isNuN(abc) ? [] : abc.hideword;
    const excludes = isNuN(abc) ? [] : abc.execludeWords;

    for (const word of words) {
      const regw = new RegExp(word, 'gis');
      if (regw.test(youtubeItem.ytTitle) || regw.test(youtubeItem.userNam)) {
        item.classList.add('remove_item');
        youtubeItem.word = word;
        console.log('> hide all words : ', youtubeItem);
        break;
      }
    }
    for (const word of excludes) {
      const regw = new RegExp(word, 'gis');
      if (regw.test(youtubeItem.ytTitle) || regw.test(youtubeItem.userNam)) {
        item.classList.remove('remove_item');
        // console.log('> un hide words : ', youtubeItem);
        break;
      }
    }
  };
  const scaleShowMovie = async (area, item) => {
    if (!item.classList.contains('target')) {
      item.classList.add('target');
      // console.log('test2 1件ずつ', item);
      await removeMovieInformation(item);

      item.classList.add('show');
      item.classList.add('minScale');

      document.addEventListener('click', async (e) => {
        const ytArea = await waitQuerySelector(area);
        if (e.target.classList.contains('target')) {

          const device = 'www.youtube.com' === location.hostname || 'm.youtube.com' === location.hostname ? true : false;
          const searcher = new RegExp(regSearch, 'gis');
          if (device && searcher.test(location.pathname)) {
            for (const result of ytArea.querySelectorAll('ytd-item-section-renderer > div#contents, ytm-item-section-renderer > lazy-list')) {
              for (const ytItem of result.children) {
                ytItem.classList.add('minScale');
              }
            }
          }

          for (const ytItem of ytArea.children) {
            ytItem.classList.add('minScale');
          }
          e.target.classList.remove('minScale');
        }
      });
    }
  };
  const initial = async (area) => {
    const ytArea = await waitQuerySelector(area);
    const ytMovies = ytArea.querySelectorAll('.target');
    for (const ytTarget of ytMovies) {
      ytTarget.classList.remove('target', 'show');
    }
    await new Promise(resolve => setTimeout(resolve, waitTime * 2));

    const searcher = new RegExp(regSearch, 'gis');
    const config = { 'attributes': false, 'childList': true, 'subtree': true };
    const moScal = new MutationObserver(async () => {
      if (searcher.test(location.pathname)) {
        console.log('> ytMovie search result');

        for (const result of ytArea.querySelectorAll('ytd-item-section-renderer > div#contents, ytm-item-section-renderer > lazy-list')) {
          for (const ytItem of result.children) {
            scaleShowMovie(area, ytItem);
          }
        }
      } else {
        console.log('> ytMovie check result...');

        for (const ytItem of ytArea.children) {
          scaleShowMovie(area, ytItem);
        }
      }
    });
    moScal.observe(document, config);
  };
  const changeUrl = async () => {
    let href;

    const url_config = { 'attributes': false, 'childList': true, 'subtree': true };
    const url_obs = new MutationObserver(async () => {
      // const href_path = location.pathname;
      const href_path = location.pathname + '/' + location.search;
      if (href !== href_path) {
        // console.log('Before:', href);
        // console.log('After:', location.href);
        href = href_path;

        const path = new RegExp('(^/$)|(^/feed/subscriptions)|(^/watch|^/live)|(^/results)|(^/@.+|^/channel/.+|^/c/.+|^/user/.+|^/u/.+)', 'gis');
        const flag = isNuN(excChannel) ? false : new RegExp(excChannel, 'gis').test(location.pathname);
        const reg = path.test(location.pathname);
        if (!reg) { return false; }
        if (flag) { return false; }

        // 動画エリア初期非表示
        for (const yt of itemsArray) {
          elemMov.textContent += yt.area + ' { display: none; } ';
        }

        // 動画URLから「t=」パラメータを排除
        const pathTime = new RegExp('&t=.+', 'gis');
        if (pathTime.test(location.href)) {
          const replaceURL = deleteParam(location.href, 't').href;
          location.replace(replaceURL);
        }

        // watch
        const watcher = new RegExp(regWatch, 'gis');
        if (!watcher.test(location.pathname)) {
          // Modal Loading... style 初期化
          elemDom.textContent = '';
          elemDom.textContent += 'body { overflow-y: hidden !important; } ';
          elemDom.textContent += '#ytLoader { position: fixed !important; z-index: 9999 !important; width: 100%; height: 100%; bottom: 0px; right: 0px; overflow: hidden; color: white; background-color: #000; display: block; } ';
          elemDom.textContent += '#ytLoader > div { display: block; position: absolute; top: 50%; left: 50%; width: 50px; aspect-ratio: 1; border-radius: 50%; background: radial-gradient(farthest-side, #ffa516 94%, #0000) top / 8px 8px no-repeat, conic-gradient(#0000 30%, #ffa516); -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 8px), #000 0); animation: l13 1s infinite linear; } @keyframes l13{ 100% { transform: rotate(1turn) } } ';
        }

        // youtube Area Manager
        await waitQuerySelector(manager);

        // channel replace
        const channel = new RegExp(regChannel, 'gis');
        if (channel.test(location.pathname)) {
          const pathChannel = location.pathname.split(/@|\/channel\/|\/c\/|\/user\/|\/u\//)[1].split('/')[0];
          if (userName !== pathChannel) {
            userName = pathChannel;
            console.log('> youtube channel name...', userName);
            channelManager(userName);
          }
        } else {
          // チャンネルではなくなったら、ユーザー開放
          userName = '';
        }

        // movie contents
        const ytArray = itemsArray.filter((yt) => location.hostname === yt.device);
        for await (const yt of ytArray) {
          const path = new RegExp(yt.path, 'gis');
          // console.log(path, location.pathname);
          if (path.test(location.pathname)) {
            console.log('> youtube get ...', path, yt.area);
            await initial(yt.area);
          }
        }

        if (watcher.test(location.pathname)) {
          ytChatArea();
        }
        await new Promise(resolve => setTimeout(resolve, waitTime * 10));

        // style 無効化
        elemDom.textContent = '';
        elemMov.textContent = '';
      }
    });
    url_obs.observe(document, url_config);
  };

  // URLが変更されたとき
  changeUrl();
})();
