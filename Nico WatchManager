// ==UserScript==
// @name         Nico WatchManager
// @namespace    http://tampermonkey.net/
// @version      2.0
// @description  サイト設定 自動再生オンにすること > 自動遷移後の再生のため
// @author       You
// @match        https://*.nicovideo.jp/*
// @grant        none
// @icon         https://www.google.com/s2/favicons?domain=www.nicovideo.jp
// @run-at       document-body
// @noframes
// ==/UserScript==

(function() {
  'use strict';

  // ==========================================================
  // 変数宣言
  const waitTime = 500;
  const regWatch = '/watch';
  // 可変数
  let ncMutation;
  // ==========================================================
  // 静的style適用エリア
  const elemStyle = document.createElement('style');
  elemStyle.id = 'nicoStylusManager';
  document.head.insertAdjacentElement('beforeend', elemStyle);

  elemStyle.textContent += 'a[href*="/premium"] { display: none !important; } ';
  // ==========================================================

  // eslint-disable-next-line no-unused-vars
  const isNuN = (selector) => {
    if (selector === null || selector === undefined || selector === '') { return true; } else { return false; }
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelector = async (selector, node = document) => {
    let obj = null;
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 100));
      obj = node.querySelector(selector);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorCount = async (cnt, selector, node = document) => {
    let obj = null;
    let num = 0;
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, 1000));
      if (num < cnt) {
        obj = node.querySelector(selector);
        num++;
        if (!obj) { return obj; }
      } else {
        break;
      }
    }
    while (!obj) {
      await new Promise(resolve => setTimeout(resolve, waitTime));
      obj = node.querySelector(selector);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const waitQuerySelectorIframe = async (selector1, selector2, node = document) => {
    let obj = null;
    while (!obj) {
      // iframe.contentWindow.document === iframe.contentDocument
      await new Promise(resolve => setTimeout(resolve, 500));
      obj = node.querySelector(selector1).contentDocument.querySelector(selector2);
    }
    return obj;
  };
  // eslint-disable-next-line no-unused-vars
  const deleteParam = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;
    params.delete(param);

    return url;
  };
  // eslint-disable-next-line no-unused-vars
  const searchParams = (searchUrl, param) => {
    const base = new URL(location.protocol + '//' + location.hostname);
    const url = new URL(searchUrl, base);
    console.log('url section', url);
    // URLSearchParamsオブジェクトを取得
    const params = url.searchParams;

    return params.get(param);
  };
  // eslint-disable-next-line no-unused-vars
  const getParam = (name, url) => {
    if (!url) url = window.location.href;
    name = name.replace(/[\\[\]]/g, '\\$&');
    let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    let results = regex.exec(url);

    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  };
  // eslint-disable-next-line no-unused-vars
  const userAgent = () => {
    const userDevice = navigator.userAgent;
    if (userDevice.indexOf('iPhone') > 0 || userDevice.indexOf('iPod') > 0 || userDevice.indexOf('Android') > 0 && userDevice.indexOf('Mobile') > 0) {
      return false;
    } else if (userDevice.indexOf('iPad') > 0 || userDevice.indexOf('Android') > 0) {
      return false;
    } else {
      // pc
      return true;
    }
  };

  const playingWatchM = async () => {
    const ncvid = 'div#watchVideoContainer.watch-Video_Container > video';
    const ncbtn = 'div.watch-OpeningPlayerInfo_Container > button#jsWatchThisPage.watch-OpeningPlayerInfo_PlayButton';
    await waitQuerySelector('div.watch-Player_Container');
    // サイト設定 自動再生オンにすること
    await new Promise(resolve => setTimeout(resolve, waitTime * 4));
    await waitQuerySelector(ncvid);
    await waitQuerySelector(ncbtn);
    document.querySelector(ncbtn).click();

    ncMutation = new MutationObserver(async () => {
      if (document.querySelector('div.watch-Player_Container').classList.contains('is-playing')) { // 再生開始
        if (document.querySelector('div.watch-PlayerUpperControllerDock_CommentToggle') !== null) {
          if (!document.querySelector('div.watch-PlayerUpperControllerDock_CommentToggle').classList.contains('off')) {
            document.querySelector('div.watch-PlayerUpperControllerDock_CommentToggle').click();
          }
        }
        if (document.querySelector('button.watch-OpenCommentListButton') !== null) {
          if (document.querySelector('div.watch-OpenCommentListButton_Count').textContent != '閉じる') {
            document.querySelector('button.watch-OpenCommentListButton').click();
          }
        }
      } else if (document.querySelector('div.watch-Player_Container').classList.contains('screen-close')) { // 次のシリーズがあれば遷移
        if (document.querySelector('div.watch-VideoDescription-Body_Series') !== null) {
          let series = document.querySelector('div.watch-VideoDescription-Body_Series');
          if (series.querySelector('a.watch-VideoDescription-Body_SeriesNext') !== null) {
            series.querySelector('a.watch-VideoDescription-Body_SeriesNext').click();
          }
        }
      }
    });
    const config = { 'attributes': true, 'childList': false, 'subtree': false };
    ncMutation.observe(document.querySelector('div.watch-Player_Container'), config);
  };
  const playingWatchW = async () => {
    const player = await waitQuerySelector('div[class^="grid-area_"][class*="player"] div.PlayerPresenter video');

    // 広場、チャット、シリーズ、広告エリア 削除
    const hiroba = document.querySelector('div.d_flex.flex-d_column:has(> * > button[data-element-name="hiroba_navigation"])');
    const ncChat = document.querySelector('div[class^="grid-area_"][class*="sidebar"] > div > div[class*="pos_relative"]:not(:has([data-scope="tabs"])):has(> section)');
    const series = document.querySelector('div[class^="grid-area_"][class*="sidebar"] > div > section');
    if (!isNuN(hiroba)) { hiroba.remove(); }
    if (!isNuN(ncChat)) { ncChat.remove(); }
    if (!isNuN(series)) { series.remove(); }

    for (const img of document.querySelectorAll('div[class^="grid-area_"][class*="sidebar"] > div > div[data-scope="tabs"][data-part="root"] > div[data-scope="tabs"][data-part="content"] > div > div[id^="img_"]')) {
      img.remove();
    }
    ncMutation = new MutationObserver(async () => {
      const hiroba = document.querySelector('div.d_flex.flex-d_column:has(> * > button[data-element-name="hiroba_navigation"])');
      const ncChat = document.querySelector('div[class^="grid-area_"][class*="sidebar"] > div > div[class*="pos_relative"]:not(:has([data-scope="tabs"])):has(> section)');
      const series = document.querySelector('div[class^="grid-area_"][class*="sidebar"] > div > section');
      if (!isNuN(hiroba)) { hiroba.remove(); }
      if (!isNuN(ncChat)) { ncChat.remove(); }
      if (!isNuN(series)) { series.remove(); }

      for (const img of document.querySelectorAll('div[class^="grid-area_"][class*="sidebar"] > div > div[data-scope="tabs"][data-part="root"] > div[data-scope="tabs"][data-part="content"] > div > div[id^="img_"]')) {
        img.remove();
      }
    });
    const config = { 'attributes': false, 'childList': true, 'subtree': true };
    ncMutation.observe(document.querySelector('div[class^="grid-area_"][class*="sidebar"]'), config);

    player.addEventListener('ended', async (event) => {
      console.log('ended');
      // const bottomPrev = await waitQuerySelectorCount(5, 'div[class^="grid-area_"][class*="bottom"] div.gap_base > a[data-anchor-page="watch"][data-anchor-area="series"][data-anchor-detail="prev"]');
      const bottomNext = await waitQuerySelectorCount(5, 'div[class^="grid-area_"][class*="bottom"] div.gap_base > a[data-anchor-page="watch"][data-anchor-area="series"][data-anchor-detail="next"]');
      location.href = bottomNext.href;
    });
  };
  const changeUrl = async () => {
    let href;

    const url_config = { 'attributes': false, 'childList': true, 'subtree': true };
    const url_obs = new MutationObserver(async () => {

      if (href != location.pathname + location.search) {
        // console.log('Before:', href);
        // console.log('After:', location.href);
        href = location.pathname + location.search;

        if (!isNuN(ncMutation)) { ncMutation.disconnect(); }

        dialogHide();
        const watch = new RegExp(regWatch, 'gis');
        const isWatch = watch.test(location.pathname);
        if (!isWatch) { return false; }

        if ('www.nicovideo.jp' == location.hostname) {
          console.log('pc > ');
          playingWatchW();
        } else {
          console.log('sp > ');
          playingWatchM();
        }
      }
    });
    url_obs.observe(document, url_config);
  };

  const dialogHide = () => {
    // 動画読み込みに失敗
    if (document.querySelector('div#jsModalDialogContainer') !== null) {
      document.querySelector('div#jsModalDialogContainer').style.display = 'none';
    }
    if (document.querySelector('div#jsMarqueeContainer') !== null) {
      document.querySelector('div#jsMarqueeContainer').style.display = 'none';
    }
    if (document.querySelector('div#jsSmartAppBanner') !== null) {
      document.querySelector('div#jsSmartAppBanner').style.display = 'none';
    }
    if (document.querySelector('a.common-header-oidyxs') !== null) {
      document.querySelector('a.common-header-oidyxs').style.display = 'none';
    }
  };

  // URLが変更されたとき
  changeUrl();
})();
